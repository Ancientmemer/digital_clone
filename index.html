<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Bone Architect â€“ Full Body + Hands</title>
<style>
  body{margin:0;overflow:hidden;background:#000}
  video{
    position:fixed; inset:0;
    width:100vw;height:100vh;
    object-fit:cover;
    transform:scaleX(-1);
    z-index:-1;
  }
  canvas{position:fixed; inset:0}
</style>
</head>

<body>
<video id="video" autoplay playsinline></video>
<canvas id="three"></canvas>

<!-- MediaPipe -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<!-- Three.js -->
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>

<script>
/* ================= SCENE ================= */
const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(45,innerWidth/innerHeight,0.1,100);
camera.position.set(0,1.6,4);

const renderer=new THREE.WebGLRenderer({canvas:three,alpha:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(devicePixelRatio);

const video=document.getElementById("video");
scene.background=new THREE.VideoTexture(video);

/* ================= MATERIAL ================= */
const mat=new THREE.LineBasicMaterial({color:0x00f0ff});

/* ================= BONE HELPERS ================= */
function bone(){
  return new THREE.Line(
    new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(),new THREE.Vector3()]),
    mat
  );
}

function vec(p){
  return new THREE.Vector3(
    (1-p.x)*2-1,
    (1-p.y)*2-1,
    -p.z*2
  );
}

function setBone(b,a,c){
  b.geometry.setFromPoints([a,c]);
}

/* ================= SKELETON ================= */
const skeleton=new THREE.Group();
scene.add(skeleton);

const bones={
  head:bone(), spine:bone(),

  lUA:bone(), lLA:bone(),
  rUA:bone(), rLA:bone(),

  lUL:bone(), lLL:bone(),
  rUL:bone(), rLL:bone()
};

Object.values(bones).forEach(b=>skeleton.add(b));

/* ================= HAND BONES ================= */
function makeHand(){
  const lines=[];
  for(let i=0;i<21;i++) lines.push(bone());
  lines.forEach(l=>skeleton.add(l));
  return lines;
}

const leftHand = makeHand();
const rightHand = makeHand();

/* ================= MEDIAPIPE POSE ================= */
const pose=new Pose({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
pose.setOptions({
  modelComplexity:1,
  smoothLandmarks:true,
  minDetectionConfidence:0.7,
  minTrackingConfidence:0.7
});

/* ================= MEDIAPIPE HANDS ================= */
const hands=new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
hands.setOptions({
  maxNumHands:2,
  modelComplexity:1,
  minDetectionConfidence:0.7,
  minTrackingConfidence:0.7
});

/* ================= UPDATE POSE ================= */
pose.onResults(r=>{
  if(!r.poseLandmarks) return;
  const lm=r.poseLandmarks;

  const head=vec(lm[0]);
  const LS=vec(lm[11]), RS=vec(lm[12]);
  const LE=vec(lm[13]), RE=vec(lm[14]);
  const LW=vec(lm[15]), RW=vec(lm[16]);
  const LH=vec(lm[23]), RH=vec(lm[24]);
  const LA=vec(lm[27]), RA=vec(lm[28]);

  const shoulderMid=LS.clone().add(RS).multiplyScalar(0.5);
  const hipMid=LH.clone().add(RH).multiplyScalar(0.5);

  skeleton.position.lerp(shoulderMid,0.25);

  setBone(bones.head, shoulderMid, head);
  setBone(bones.spine, shoulderMid, hipMid);

  setBone(bones.lUA, shoulderMid, LS);
  setBone(bones.lLA, LS, LW);
  setBone(bones.rUA, shoulderMid, RS);
  setBone(bones.rLA, RS, RW);

  setBone(bones.lUL, hipMid, LH);
  setBone(bones.lLL, LH, LA);
  setBone(bones.rUL, hipMid, RH);
  setBone(bones.rLL, RH, RA);
});

/* ================= UPDATE HANDS ================= */
hands.onResults(r=>{
  if(!r.multiHandLandmarks) return;

  r.multiHandLandmarks.forEach((hand,i)=>{
    const target = r.multiHandedness[i].label==="Left" ? leftHand : rightHand;
    hand.forEach((p,idx)=>{
      const v=vec(p);
      target[idx].geometry.setFromPoints([v,v.clone().add(new THREE.Vector3(0,0.02,0))]);
    });
  });
});

/* ================= CAMERA ================= */
new Camera(video,{
  onFrame:async()=>{
    await pose.send({image:video});
    await hands.send({image:video});
  },
  width:1280,height:720
}).start();

/* ================= LOOP ================= */
(function animate(){
  requestAnimationFrame(animate);
  renderer.render(scene,camera);
})();
</script>
</body>
</html>
